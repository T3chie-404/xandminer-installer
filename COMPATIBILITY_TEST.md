# Compatibility Test - /opt/xandeum Structure

## Directory Structure

```
/opt/xandeum/
├── xandminer/          # Web interface repository
├── xandminerd/         # Daemon repository
└── logs/               # Pod logs directory
```

## Path Verification

### Installation Paths
- Base: `/opt/xandeum/`
- xandminer: `/opt/xandeum/xandminer/`
- xandminerd: `/opt/xandeum/xandminerd/`
- Logs: `/opt/xandeum/logs/pod.log`
- Keypair: `/local/keypairs/pnode-keypair.json`

### Service Files

**xandminer.service:**
```
WorkingDirectory=/opt/xandeum/xandminer
ExecStart=/usr/bin/npm start
User=xand
```

**xandminerd.service:**
```
WorkingDirectory=/opt/xandeum/xandminerd
ExecStart=/usr/bin/node src/index.js
User=xand
```

**pod.service:**
```
ExecStart=/usr/bin/pod --atlas-ip ... --log /opt/xandeum/logs/pod.log
User=xand
```

## Test Commands

### Test 1: Directory Creation
```bash
# Should create /opt/xandeum/
mkdir -p /opt/xandeum
ls -la /opt/ | grep xandeum
# Expected: drwxr-xr-x ... xandeum
```

### Test 2: Repository Cloning
```bash
cd /opt/xandeum
git clone https://github.com/Xandeum/xandminer.git
git clone https://github.com/Xandeum/xandminerd.git
ls -la
# Expected: xandminer/ and xandminerd/ directories
```

### Test 3: Service File Generation
```bash
INSTALL_BASE="/opt/xandeum"
echo "WorkingDirectory=$INSTALL_BASE/xandminer"
# Expected: WorkingDirectory=/opt/xandeum/xandminer
```

### Test 4: Log Directory Creation
```bash
POD_LOG_PATH="/opt/xandeum/logs/pod.log"
mkdir -p "$(dirname "$POD_LOG_PATH")"
ls -la /opt/xandeum/logs/
# Expected: Directory created successfully
```

### Test 5: Ownership
```bash
sudo chown -R xand:xand /opt/xandeum/xandminer
sudo chown -R xand:xand /opt/xandeum/xandminerd
ls -la /opt/xandeum/
# Expected: xand:xand ownership
```

## Compatibility Checks

### Check 1: User Home Directory
```bash
id xand
# Expected: uid=... gid=... home=/opt/xandeum
```

### Check 2: Service User Permissions
```bash
sudo -u xand test -w /opt/xandeum/xandminer && echo "✓ xand can write to xandminer"
sudo -u xand test -w /opt/xandeum/xandminerd && echo "✓ xand can write to xandminerd"
sudo -u xand test -w /opt/xandeum/logs && echo "✓ xand can write to logs"
```

### Check 3: npm Commands
```bash
cd /opt/xandeum/xandminer
sudo -u xand npm install
# Should work without permission errors
```

### Check 4: Service Startup
```bash
sudo systemctl start xandminer.service
sudo systemctl status xandminer.service
# Expected: active (running)
```

## Migration from /opt/xandminer to /opt/xandeum

If you previously installed with `/opt/xandminer/`:

```bash
# Stop services
sudo systemctl stop xandminer.service xandminerd.service pod.service

# Create new structure
sudo mkdir -p /opt/xandeum

# Move old installations
sudo mv /opt/xandminer /opt/xandeum/xandminer
sudo mv /opt/xandminerd /opt/xandeum/xandminerd

# Update ownership
sudo chown -R xand:xand /opt/xandeum

# Move logs if they exist
sudo mkdir -p /opt/xandeum/logs
sudo mv /opt/xandminer/pod-logs/* /opt/xandeum/logs/ 2>/dev/null || true

# Update service files (will be regenerated by installer)
# Or run: sudo ./install.sh --non-interactive --update --atlas-cluster devnet
```

## Verification Checklist

After installation, verify:

- [ ] `/opt/xandeum/` directory exists
- [ ] `/opt/xandeum/xandminer/` has code (package.json, src/, etc.)
- [ ] `/opt/xandeum/xandminerd/` has code (package.json, src/, etc.)
- [ ] `/opt/xandeum/logs/` directory exists
- [ ] All owned by `xand:xand`
- [ ] Services reference correct WorkingDirectory
- [ ] Services start successfully
- [ ] Web interface accessible (port 3000)
- [ ] API accessible (port 4000)
- [ ] Pod service running correctly

## Expected Results

```bash
$ ls -la /opt/
drwxr-xr-x  3 root root 4096 ... xandeum

$ ls -la /opt/xandeum/
drwxr-xr-x  3 xand xand 4096 ... xandminer
drwxr-xr-x  3 xand xand 4096 ... xandminerd
drwxr-xr-x  2 xand xand 4096 ... logs

$ ps aux | grep xandminer
xand  12345  ... npm start  (in /opt/xandeum/xandminer)
xand  12346  ... node src/index.js  (in /opt/xandeum/xandminerd)

$ sudo systemctl status xandminer.service | grep WorkingDirectory
WorkingDirectory=/opt/xandeum/xandminer
```

---

**All paths updated and tested! ✅**

